
[[extend 'layout.html']]

[[ block page_head ]]


    <title>Long Celery Task</title>
    <script src="https://cdn.socket.io/4.4.0/socket.io.min.js"></script>

<style>

body{
    background: #F8F8F8;
    font-family: 'Courier New', Courier, monospace;
}

</style>
[[end ]]

    <p>To test it, you need to run the celery-worker (. worker.sh) </p>
    <button type="button">Run Celery Task</button>
    <br>
    Result: <span id="result"></span>

<script>
    const resultElement = document.getElementById('result'),
          client = io("[[ = t_vars['sio_serv_url'] ]]");

    let clientid = null;

    client.on('longtask_register', function(id) {
        clientid = id;
    });

    client.on('longtask_result', function(result) {
        console.log('!!!!!!!!!!!!!!!');
        resultElement.textContent = result;
    });

    document.querySelector('button').onclick = function() {
        const request = new XMLHttpRequest();
        request.open('POST', "[[ = t_vars['longtask_run_url'] ]]" , true);
        request.setRequestHeader(
            'Content-Type',
            'application/x-www-form-urlencoded; charset=utf-8');
        request.onload = function() {
            resultElement.textContent = request.responseText;
        };
        request.send('clientid=' + clientid);
    };
</script>


</body>
</html>


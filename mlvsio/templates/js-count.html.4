[[extend 'layout.html']]

[[ block page_head ]]
<link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQYV2PYF773PwAGewLSGezkXwAAAABJRU5ErkJggg=="/>
<script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
<title>Counter</title>


<style>

body{
    background: #cccccc;
    font-family: 'Courier New', Courier, monospace;
}

main{
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

#counter-board{
    font-size: 30px;
}



</style>

[[ end ]]

<main>

        <h4>Counter to/from pydal over sio</h4>
            <p id="id_status">disconnected! run chan_sio.py</p>
            <!-- where the counter will be displayed-->
            <p id="counter-board">?</p>
        <!-- Button section -->
        <section class="buttons-section">
            <button id="increase-btn">Increase</button>
            <button id="reset-btn">Reset</button>
            <button id="decrease-btn">Decrease</button>
        </section>

</main>

 <script> 
 ! function (sio_url, init_value) {

            const socket = io.connect( sio_url );
            const py_var = 'counter';

            socket.on('connect', ()=> {
                socket.emit('sync_hello_connect', {data: 'hello from ' + py_var });
                document.getElementById("id_status").innerHTML = 'connect, sio_channel=  ' + sio_url
                //console.log('joke connected')
            });

            socket.on('disconnect', ()=> {
                document.getElementById("id_status").innerHTML = 'disconnect!'
                // console.error('Jokes closed')
                // console.log('joke disconnected')
            });

            socket.on('reconnect', ()=>{
                document.getElementById("id_status").innerHTML = 'reconnect!'
                //console.log('chart reconnected')
            });


            // if (typeof socket !== undefined || socket !== null) {

            if (typeof socket != 'undefined' && socket) {
        
        
                // variable holding the counter value
                let counterValue = init_value ;
                
                // get the increase and decrease button
                const incrementButton = document.getElementById("increase-btn");
                const decrementButton = document.getElementById("decrease-btn");
                const resetButton = document.getElementById("reset-btn");
                
                // function that increases the counter by 1
                const increaseCounter = () =>{
                    counterBoard.innerHTML = ++counterValue;
                    socket.emit('var_increment', {data: py_var, value:  counterBoard.innerHTML    });
                }
                
                // function that decreases the counter by 1
                const decreaseCounter = () =>{
                    counterBoard.innerHTML = --counterValue;
                    socket.emit('var_decrement', {data: py_var, value:  counterBoard.innerHTML  });
                }
                
                const resetCounter = () =>{
                    // Update the UI
                    counterBoard.innerHTML = 0;
                    // Update the variable container
                    counterValue = 0;
                    socket.emit('var_reset', {data: py_var, value:  counterBoard.innerHTML    });
                }
                
                
                // get the counter board value
                const counterBoard = document.getElementById("counter-board");
                if (counterBoard.innerHTML === '?' ) {
                   counterBoard.innerHTML = init_value;
                   }
                
                
                // Add event listener to the buttons
                incrementButton.addEventListener('click', increaseCounter);
                decrementButton.addEventListener('click', decreaseCounter);
                resetButton.addEventListener('click', resetCounter);
        
          }else {
           console.log("=== ", socket)
          };      
         
   } ( "[[ = t_vars['sio_serv_url'] ]]" , [[=  t_vars['counter'] ]]  );
                
 </script>
                
                
